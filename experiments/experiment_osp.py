import time

from data.plotter_evaluation import format_time
from experiments.experiment_pruning import ExperimentPruning
from training.logger import log_from_medium


def mimic_next_prune_rate(curr_prune_rate, prune_rate_specs):
    """ Mimic the next pruning-rate from the current pruning-rate and the rate from specs. """
    return curr_prune_rate + (1 - curr_prune_rate) * prune_rate_specs


class ExperimentOSP(ExperimentPruning):
    """
    Experiment with one-shot pruning.
    Train the nets with sparsity 100% once and apply several pruning rates.
    The pruning rates mimic levels of sparsity as generated by IMP.
    Retrain and evaluate nets after each pruning step.
    """

    def __init__(self, specs, result_path='../data/results'):
        super(ExperimentOSP, self).__init__(specs, result_path)

    # noinspection DuplicatedCode
    def execute_experiment(self):
        """ Perform one-shot pruning and save accuracy- and loss-histories after each training.
        Retrain subnetworks to evaluate accuracies. """
        for n in range(self.specs.net_count):
            curr_original_net = None
            curr_prune_rate_conv, curr_prune_rate_fc = 0, 0

            for p in range(0, self.specs.prune_count + 1):
                tic = time.time()
                if p > 0:
                    log_from_medium(self.specs.verbosity, f"Prune network #{n} in round {p}. ", False)
                    curr_prune_rate_conv = mimic_next_prune_rate(curr_prune_rate_conv, self.specs.prune_rate_conv)
                    curr_prune_rate_fc = mimic_next_prune_rate(curr_prune_rate_fc, self.specs.prune_rate_fc)
                    self.nets[n] = curr_original_net.get_new_instance(reset_weight=False)
                    self.nets[n].prune_net(curr_prune_rate_conv, curr_prune_rate_fc, reset=True)

                if n == 0:
                    self.hists.sparsity[p] = self.nets[0].sparsity_report()[0]

                log_from_medium(self.specs.verbosity, f"Train network #{n} (sparsity {self.hists.sparsity[p]:6.4f}).")
                (self.nets[n], self.hists.train_loss[n, p], self.hists.val_loss[n, p], self.hists.val_acc[n, p],
                 self.hists.test_acc[n, p], self.stop_hists.histories[n].indices[p],
                 self.stop_hists.histories[n].state_dicts[p]) \
                    = self.trainer.train_net(self.nets[n], self.specs.epoch_count, self.specs.plot_step)

                if p == 0:
                    curr_original_net = self.nets[n].get_new_instance(reset_weight=False)

                toc = time.time()
                log_from_medium(self.specs.verbosity,
                                f"Final test-accuracy: {(self.hists.test_acc[n, p, -1]):6.4f} "
                                f"(took {format_time(toc - tic)}).")
            log_from_medium(self.specs.verbosity, "")
